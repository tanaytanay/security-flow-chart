<!DOCTYPE html>
<meta charset="utf-8">
<body>
<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
const width = 1000;
const height = 500;

// Hierarchical version of your data
const hierarchyData = {
  name: "Attacker",
  type: "attacker",
  children: [
    {
      name: "VM",
      type: "vm",
      children: [
        { name: "ingress", type: "ingress-circle" },
        { name: "egress", type: "egress-circle" },
        {
          name: "Agent 1",
          type: "agent",
          children: [
            { name: "LLM1", type: "llm" },
            { name: "LLM2", type: "llm" },
            { name: "LLM3", type: "llm" },
            { name: "LLM4", type: "llm" }
          ]
        },
        {
          name: "Agent 2",
          type: "agent",
          children: [{ name: "LLM1", type: "llm" }]
        },
        {
          name: "Agent 3",
          type: "agent",
          children: [
            { name: "LLM1", type: "llm" },
            { name: "LLM2", type: "llm" },
            { name: "LLM3", type: "llm" }
          ]
        }
      ]
    }
  ]
};

// Highlight config
const highlight = {
  circle: "ingress",
  agentName: "Agent 1",
  llmName: "LLM3",
  color: "#e74c3c"
};

const root = d3.hierarchy(hierarchyData);

// Filter out ingress/egress for layout
const filteredRoot = d3.hierarchy(hierarchyData);
filteredRoot.descendants().forEach(node => {
  if (node.data.type === "ingress-circle" || node.data.type === "egress-circle") {
    const parent = node.parent;
    if (parent) {
      parent.children = parent.children.filter(child => child !== node);
    }
  }
});

const treeLayout = d3.tree().size([height, width - 200]);
treeLayout(filteredRoot);

// SVG
const svg = d3.select("body").append("svg")
  .attr("width", width)
  .attr("height", height);

// Define arrow marker
svg.append("defs").append("marker")
  .attr("id", "arrowhead")
  .attr("viewBox", "0 -5 10 10")
  .attr("refX", 10)
  .attr("refY", 0)
  .attr("markerWidth", 6)
  .attr("markerHeight", 6)
  .attr("orient", "auto")
  .append("path")
  .attr("d", "M0,-5L10,0L0,5")
  .attr("fill", "#000");

// Group for layout
const g = svg.append("g")
  .attr("transform", "translate(50,0)");

// Links
g.selectAll(".link")
  .data(filteredRoot.links())
  .enter()
  .append("path")
  .attr("fill", "none")
  .attr("stroke", d => isHighlightedEdge(d) ? highlight.color : "#000")
  .attr("stroke-width", d => isHighlightedEdge(d) ? 3 : 1)
  .attr("marker-end", "url(#arrowhead)")
  .attr("d", d3.linkHorizontal()
    .x(d => d.y)
    .y(d => d.x)
  );

// Nodes
const node = g.selectAll(".node")
  .data(filteredRoot.descendants())
  .enter()
  .append("g")
  .attr("class", "node")
  .attr("transform", d => `translate(${d.y},${d.x})`);

node.each(function(d) {
  if (d.data.type === "vm") {
    d3.select(this).append("rect")
      .attr("x", -60)
      .attr("y", -40)
      .attr("width", 120)
      .attr("height", 80)
      .attr("fill", "#a8a8a8")
      .attr("stroke", "#888");

    d3.select(this).append("text")
      .attr("dy", -15)
      .attr("text-anchor", "middle")
      .attr("font-weight", "bold")
      .text(d.data.name);

    // ingress circle inside VM
    d3.select(this).append("circle")
      .attr("r", 15)
      .attr("cx", -30)
      .attr("cy", -10)
      .attr("fill", highlight.circle === "ingress" ? highlight.color : "#3498db")
      .attr("stroke", "#fff");

    d3.select(this).append("text")
      .attr("x", -30)
      .attr("y", -5)
      .attr("text-anchor", "middle")
      .attr("fill", "#fff")
      .attr("font-size", "10px")
      .text("ingress");

    // egress circle inside VM
    d3.select(this).append("circle")
      .attr("r", 15)
      .attr("cx", 30)
      .attr("cy", -10)
      .attr("fill", highlight.circle === "egress" ? highlight.color : "#3498db")
      .attr("stroke", "#fff");

    d3.select(this).append("text")
      .attr("x", 30)
      .attr("y", -5)
      .attr("text-anchor", "middle")
      .attr("fill", "#fff")
      .attr("font-size", "10px")
      .text("egress");

  } else {
    d3.select(this).append("circle")
      .attr("r", d.data.type === "attacker" ? 25 : d.data.type === "agent" ? 22 : 20)
      .attr("fill", isHighlightedNode(d) ? highlight.color : "#3498db")
      .attr("stroke", "#fff");

    d3.select(this).append("text")
      .attr("dy", 4)
      .attr("text-anchor", "middle")
      .attr("fill", "#fff")
      .attr("font-size", d.data.type === "attacker" ? "12px" : d.data.type === "agent" ? "11px" : "10px")
      .text(d.data.name);
  }
});

// --- Highlight helpers ---
function isHighlightedNode(d) {
  return (
    d.data.name === "Attacker" ||
    d.data.name === "VM" ||
    d.data.name === highlight.agentName ||
    d.data.name === highlight.llmName
  );
}

function isHighlightedEdge(link) {
  const pathSequence = [
    ["Attacker", "VM"],
    ["VM", highlight.agentName],
    [highlight.agentName, highlight.llmName]
  ];
  return pathSequence.some(([src, dst]) =>
    link.source.data.name === src && link.target.data.name === dst
  );
}
</script>
