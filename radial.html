<!DOCTYPE html>
<meta charset="utf-8">
<body>
<svg width="800" height="600"></svg>
<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
const svg = d3.select("svg");
const width = +svg.attr("width");
const height = +svg.attr("height");

// --- Define hubs ---
const hubs = [
  { id: "hub1", x: width/2, y: height/4, icon: "icons/aif-logo_p.png", label: "aiF 1" },
  { id: "hub2", x: width/4, y: (3*height)/4, icon: "icons/aif-logo_p.png", label: "aiF 2" },
  { id: "hub3", x: (3*width)/4, y: (3*height)/4, icon: "icons/aif-logo_p.png", label: "aiF 3" }
];

// --- Define children ---
const children = [
  { id: "c1", icon: "icons/attackers.png", label: "Att 1" },
  { id: "c2", icon: "icons/attackers.png", label: "Att 2" },
  { id: "c3", icon: "icons/attackers.png", label: "Att 3" },
  { id: "c4", icon: "icons/attackers.png", label: "Att 4" },
  { id: "c5", icon: "icons/attackers.png", label: "Att 5" },
  { id: "c6", icon: "icons/attackers.png", label: "Att 6" }
];

// --- Define links ---
const links = [
  { source: "hub1", target: "c1" },
  { source: "hub1", target: "c2" },
  { source: "hub2", target: "c2" },
  { source: "hub2", target: "c3" },
  { source: "hub3", target: "c3" },
  { source: "hub3", target: "c4" },
  { source: "hub1", target: "c5" },
  { source: "hub3", target: "c5" },
  { source: "hub2", target: "c6" }
];

// --- Position children around hubs ---
const radius = 80;
hubs.forEach(hub => {
  const hubChildren = links
    .filter(l => l.source === hub.id)
    .map(l => children.find(c => c.id === l.target));

  hubChildren.forEach((child, i) => {
    if (child.x === undefined && child.y === undefined) {
      child.x = hub.x + radius * Math.cos((2 * Math.PI * i) / hubChildren.length);
      child.y = hub.y + radius * Math.sin((2 * Math.PI * i) / hubChildren.length);
    } else {
      child.x = (child.x + hub.x) / 2;
      child.y = (child.y + hub.y) / 2;
    }
  });
});

// --- Combine all nodes ---
const nodes = [...hubs, ...children];

// --- Draw links with stroke width 1 ---
const link = svg.selectAll("line")
  .data(links)
  .join("line")
  .attr("stroke", "#333")
  .attr("stroke-width", 1);

// --- Draw nodes using <g> ---
const node = svg.selectAll("g")
  .data(nodes)
  .join("g")
  .attr("transform", d => `translate(${d.x},${d.y})`)
  .call(d3.drag()
    .on("start", dragstarted)
    .on("drag", dragged)
    .on("end", dragended)
  )
  .on("click", (event, d) => {
    if (!hubs.includes(d)) childClicked(d);
  })
  // --- Hover handler moved to <g> ---
  .on("mouseover", function(event, d) {
    if (!hubs.includes(d)) return;

    const connectedChildren = links
      .filter(l => l.source === d.id)
      .map(l => l.target);

    link.attr("stroke", l => l.source === d.id ? "red" : "#ccc");

    node.select("circle").attr("fill", n => {
      if (n === d) return "#79c7b0";
      if (!hubs.includes(n) && connectedChildren.includes(n.id)) return "#FFA07A"; // connected children keep color
      return "#ccc";
    });

    node.select("text").attr("fill", n => {
      if (n === d) return "#000";
      if (!hubs.includes(n) && connectedChildren.includes(n.id)) return "#000"; // connected children text stays
      return "#555";
    });
  })
  .on("mouseout", function(event, d) {
    link.attr("stroke", "#333");
    node.select("circle").attr("fill", n => hubs.includes(n) ? "#79c7b0" : "#FFA07A");
    node.select("text").attr("fill", "#000");
  });

// --- Add circles with hub/child colors and stroke width 1 ---
node.append("circle")
  .attr("r", d => hubs.includes(d) ? 40 : 30)
  .attr("fill", d => hubs.includes(d) ? "#79c7b0" : "#FFA07A")
  .attr("stroke", "#000")
  .attr("stroke-width", 1);

// --- Add icon and label dynamically inside circle ---
node.each(function(d) {
  const group = d3.select(this);
  const radius = hubs.includes(d) ? 40 : 30;
  const iconSize = hubs.includes(d) ? 30 : 24;
  const spacing = 4;

  group.append("image")
    .attr("href", d.icon)
    .attr("x", -iconSize/2)
    .attr("y", -iconSize/2 - spacing/2)
    .attr("width", iconSize)
    .attr("height", iconSize);

  group.append("text")
    .attr("text-anchor", "middle")
    .attr("y", iconSize/2 + spacing)
    .attr("font-size", hubs.includes(d) ? 12 : 10)
    .text(d.label);
});

// --- Update positions ---
function update() {
  link
    .attr("x1", d => nodes.find(n => n.id === d.source).x)
    .attr("y1", d => nodes.find(n => n.id === d.source).y)
    .attr("x2", d => nodes.find(n => n.id === d.target).x)
    .attr("y2", d => nodes.find(n => n.id === d.target).y);

  node.attr("transform", d => `translate(${d.x},${d.y})`);
}

// --- Drag handlers ---
function dragstarted(event, d) { d3.select(this).raise(); }
function dragged(event, d) { d.x = event.x; d.y = event.y; update(); }
function dragended(event, d) {}

// --- Child click handler ---
function childClicked(child) { console.log("Child clicked:", child.id); }

// --- Initial render ---
update();
</script>
</body>
